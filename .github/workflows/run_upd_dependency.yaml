name: Upgrade NPM packages

# on:
#   workflow_dispatch:
on:
  push:
    branches:
      - 'FEC-13041-upd-dependency-script'

jobs:
  update_package_json:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Install jq for JSON processing
        run: sudo apt-get -y install jq

      - name: Check updates Kaltura dependencies
        run: |
          # Read the current package.json content
          CURRENT_CONTENT=$(cat package.json)

          # Check and update a dependency
          checkAndUpdateDependency() {
            local dependencyName="$1"
            local packageName="$2"
            local currentVersion=$(echo "$CURRENT_CONTENT" | jq -r ".kaltura.dependencies.\"$dependencyName\"")
            
            # Check if the dependency exists in package.json
            if [[ -n "$currentVersion" ]]; then
              # Get the latest version of the package using npm
              local latestVersion=$(npm show "$packageName" version)
              
              # Update the package.json file only if the version has changed
              if [[ "$currentVersion" != "$latestVersion" ]]; then
                UPDATED_CONTENT=$(echo "$CURRENT_CONTENT" | jq ".kaltura.dependencies.\"$dependencyName\" = \"$latestVersion\"")
                echo "$UPDATED_CONTENT" > package.json.tmp
                mv package.json.tmp package.json
                echo "COMMIT_REQUIRED=true" >> $GITHUB_ENV
              fi
            else
              echo "No $dependencyName dependency found in package.json"
            fi
          }

          # Check and update playkit-kaltura-cuepoints dependency
          checkAndUpdateDependency "playkit-kaltura-cuepoints" "@playkit-js/playkit-js-kaltura-cuepoints"

          # Check and update playkit-timeline dependency
          checkAndUpdateDependency "playkit-timeline" "@playkit-js/playkit-js-timeline"

          # Check and update playkit-ui-managers dependency
          checkAndUpdateDependency "playkit-ui-managers" "@playkit-js/ui-managers"

          # Print the updated package.json content
          cat package.json

      - name: Commit changes
        if: env.COMMIT_REQUIRED == 'true'
        uses: peter-evans/create-pull-request@v3
        with:
          title: 'build(deps): Upgrade NPM packages (automated)'
          delete-branch: true
          branch: 'upgrade-npm-packages-automated'
          commit-message: 'build(deps): upgrade NPM packages (automated)'

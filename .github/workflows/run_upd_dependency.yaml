name: Upgrade NPM packages

# on:
#   workflow_dispatch:
on:
  push:
    branches:
      - 'FEC-13041-upd-dependency-script'

jobs:
  update_package_json:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v2

      - name: Set up Node.js
        uses: actions/setup-node@v2
        with:
          node-version: '16.x'

      - name: Install jq for JSON processing
        run: |
          # Install jq for JSON processing
          sudo apt-get -y install jq

      - name: Get latest version of dependencies
        id: get-latest-version
        run: |
          # Get the latest version of the package using npm
          echo "LATEST_VERSION=$(npm view @playkit-js/ui-managers version)" >> $GITHUB_ENV

      - name: Update package.json
        id: update-package-json
        run: |
          # Read the current package.json content
          CURRENT_CONTENT=$(cat package.json)

          # Update the package.json file only if the version has changed
          UPDATED_CONTENT=$(echo "$CURRENT_CONTENT" | jq --arg latestVersion "$LATEST_VERSION" 'if .kaltura.dependencies."playkit-ui-managers" != $latestVersion then .kaltura.dependencies."playkit-ui-managers" = $latestVersion else . end')

          # Write the updated content to package.json.tmp
          echo "$UPDATED_CONTENT" > package.json.tmp

          # Compare the updated content with the current content
          if ! cmp -s package.json package.json.tmp; then
            mv package.json.tmp package.json
            echo "COMMIT_REQUIRED=true" >> $GITHUB_ENV
          else
            rm package.json.tmp
            echo "COMMIT_REQUIRED=false" >> $GITHUB_ENV
          fi

          # Print the updated package.json content
          cat package.json

      - name: Commit changes
        if: env.COMMIT_REQUIRED == 'true'
        uses: peter-evans/create-pull-request@v3
        with:
          title: 'build(deps): Upgrade NPM packages (automated)'
          delete-branch: true
          branch: 'upgrade-npm-packages-automated'
          commit-message: 'build(deps): upgrade NPM packages (automated)'
